datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  GUEST
  USER
  CREATOR
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VideoVisibility {
  PUBLIC
  PREMIUM
  PRIVATE
}

enum VideoStatus {
  PROCESSING
  READY
  FAILED
  PENDING_REVIEW
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

model User {
  id                String         @id @default(uuid())
  email             String         @unique
  passwordHash      String
  role              UserRole       @default(USER)
  isAgeVerified     Boolean        @default(false)
  ageVerificationProvider String?  // Veriff, Yoti, etc.
  ageVerifiedAt     DateTime?
  walletBalance     Decimal        @default(0) @db.Decimal(10, 2)
  isPremium         Boolean        @default(false)
  avatar            String?
  username          String?        @unique
  bio               String?
  
  // Relationships
  videos            Video[]
  creatorProfile    Creator?
  subscriptions     Subscription[] @relation("UserSubscriptions")
  subscribedTo      Subscription[] @relation("CreatorSubscriptions")
  comments          Comment[]
  likes             Like[]
  views             View[]
  reports           Report[]
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastLoginAt       DateTime?
  
  @@index([email])
  @@index([username])
}

model Creator {
  userId                  String              @id
  user                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  verificationStatus      VerificationStatus  @default(PENDING)
  idDocumentUrl           String?             // Encrypted S3 path
  compliance2257Records   Json?               // USC 2257 compliance data
  bannerUrl               String?
  subscriptionPrice       Decimal?            @db.Decimal(10, 2)
  revenue                 Decimal             @default(0) @db.Decimal(10, 2)
  
  verifiedAt              DateTime?
  rejectionReason         String?
  
  @@index([verificationStatus])
}

model Video {
  id                String            @id @default(uuid())
  title             String
  description       String?
  s3KeyOriginal     String?           // Path to original upload
  s3KeyHLS          String?           // Path to HLS manifest
  hlsManifestUrl    String?           // Public CDN URL for .m3u8
  thumbnailUrl      String?
  spritesheetUrl    String?           // For scrubbing preview
  
  visibility        VideoVisibility   @default(PUBLIC)
  status            VideoStatus       @default(PROCESSING)
  moderationStatus  ModerationStatus  @default(PENDING)
  
  durationSeconds   Int?
  viewCount         BigInt            @default(0)
  likeCount         BigInt            @default(0)
  
  // Tags and Categories
  tags              String[]
  category          String?
  isExplicit        Boolean           @default(true)
  
  // Creator
  creatorId         String
  creator           User              @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  // AI Moderation
  aiScanResult      Json?             // AWS Rekognition or Sightengine results
  aiConfidenceScore Float?
  
  // Relationships
  comments          Comment[]
  videoLikes        Like[]
  videoViews        View[]
  reports           Report[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  publishedAt       DateTime?
  
  @@index([creatorId])
  @@index([status])
  @@index([moderationStatus])
  @@index([visibility])
  @@index([category])
  @@index([createdAt])
}

model Subscription {
  id              String    @id @default(uuid())
  
  // Subscriber
  subscriberId    String
  subscriber      User      @relation("UserSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)
  
  // Creator
  creatorId       String
  creator         User      @relation("CreatorSubscriptions", fields: [creatorId], references: [id], onDelete: Cascade)
  
  // Payment
  processor       String    // CCBill, Segpay, Epoch
  transactionId   String    @unique
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  
  // Status
  status          String    // ACTIVE, CANCELLED, EXPIRED
  startDate       DateTime  @default(now())
  expiresAt       DateTime
  
  // Renewal
  isRecurring     Boolean   @default(true)
  cancelledAt     DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([subscriberId, creatorId])
  @@index([subscriberId])
  @@index([creatorId])
  @@index([status])
  @@index([expiresAt])
}

model Comment {
  id              String    @id @default(uuid())
  content         String
  
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  videoId         String
  video           Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  parentId        String?   // For nested replies
  parent          Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  
  isEdited        Boolean   @default(false)
  isPinned        Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([videoId])
  @@index([userId])
}

model Like {
  id              String    @id @default(uuid())
  
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  videoId         String
  video           Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  
  @@unique([userId, videoId])
  @@index([videoId])
  @@index([userId])
}

model View {
  id              String    @id @default(uuid())
  
  userId          String?   // Null for anonymous views
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  videoId         String
  video           Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  ipAddress       String?   // For fraud detection
  userAgent       String?
  watchDuration   Int?      // Seconds watched
  
  createdAt       DateTime  @default(now())
  
  @@index([videoId])
  @@index([userId])
  @@index([createdAt])
}

model Report {
  id              String    @id @default(uuid())
  reason          String
  details         String?
  
  reporterId      String
  reporter        User      @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  
  videoId         String
  video           Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  status          String    @default("PENDING") // PENDING, REVIEWED, ACTIONED
  reviewedBy      String?   // Admin user ID
  reviewedAt      DateTime?
  actionTaken     String?   // NONE, WARNING, VIDEO_REMOVED, USER_BANNED
  
  createdAt       DateTime  @default(now())
  
  @@index([videoId])
  @@index([status])
}

model AuditLog {
  id              String    @id @default(uuid())
  action          String    // VIDEO_APPROVED, USER_BANNED, PAYMENT_RECEIVED
  entityType      String    // User, Video, Subscription
  entityId        String
  performedBy     String?   // User ID or "SYSTEM"
  metadata        Json?
  ipAddress       String?
  
  createdAt       DateTime  @default(now())
  
  @@index([entityType, entityId])
  @@index([createdAt])
}
